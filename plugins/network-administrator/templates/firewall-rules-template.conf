# Firewall Configuration Template
# Network: {{network_name}}
# Generated: {{timestamp}}
# Policy: {{policy_type}} (default-deny / default-allow)

###############################################################################
# CONFIGURATION VARIABLES
###############################################################################
# WAN Interface: {{wan_interface}}
# LAN Interface: {{lan_interface}}
# DMZ Interface: {{dmz_interface}}
# Management Network: {{mgmt_network}}

###############################################################################
# DEFAULT POLICIES
###############################################################################
# Default deny all traffic (Zero Trust)
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

###############################################################################
# ALLOW ESTABLISHED/RELATED CONNECTIONS
###############################################################################
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

###############################################################################
# LOOPBACK
###############################################################################
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

###############################################################################
# MANAGEMENT ACCESS
###############################################################################
# SSH from management network only
iptables -A INPUT -s {{mgmt_network}} -p tcp --dport 22 -j ACCEPT

# SNMP monitoring (read-only)
iptables -A INPUT -s {{mgmt_network}} -p udp --dport 161 -j ACCEPT

###############################################################################
# ZONE: INTERNET → DMZ
###############################################################################
{{#each dmz_services}}
# {{comment}}
iptables -A FORWARD -i {{wan_interface}} -o {{dmz_interface}} -d {{ip}} -p {{protocol}} --dport {{port}} -j ACCEPT
{{/each}}

###############################################################################
# ZONE: LAN → INTERNET
###############################################################################
# Allow all outbound from LAN (adjust as needed)
iptables -A FORWARD -i {{lan_interface}} -o {{wan_interface}} -j ACCEPT

###############################################################################
# ZONE: LAN → DMZ
###############################################################################
{{#each lan_to_dmz_rules}}
# {{comment}}
iptables -A FORWARD -i {{lan_interface}} -o {{dmz_interface}} -s {{source}} -d {{destination}} -p {{protocol}} --dport {{port}} -j ACCEPT
{{/end}}

###############################################################################
# ZONE: DMZ → LAN (Usually Denied)
###############################################################################
# Block DMZ from initiating connections to LAN
iptables -A FORWARD -i {{dmz_interface}} -o {{lan_interface}} -j DROP

###############################################################################
# LOGGING
###############################################################################
# Log dropped packets (rate limited)
iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "DROPPED INPUT: " --log-level 7
iptables -A FORWARD -m limit --limit 5/min -j LOG --log-prefix "DROPPED FORWARD: " --log-level 7

###############################################################################
# FINAL DROP
###############################################################################
iptables -A INPUT -j DROP
iptables -A FORWARD -j DROP

# Save rules
iptables-save > /etc/iptables/rules.v4

echo "Firewall rules applied successfully"
